name: Windows, Ubuntu, and macOS libcurl build & test

on:
  push:
  pull_request:

jobs:
  windows:
    runs-on: windows-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup MSVC environment
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install libcurl via vcpkg
        run: |
          git clone https://github.com/microsoft/vcpkg.git
          .\vcpkg\bootstrap-vcpkg.bat
          .\vcpkg\vcpkg.exe install curl:x64-windows

      - name: Build certinfo
        shell: cmd
        run: |
          cl ^
            /I vcpkg\installed\x64-windows\include ^
            certinfo.c ^
            /link ^
            /LIBPATH:vcpkg\installed\x64-windows\lib ^
            libcurl.lib ws2_32.lib crypt32.lib advapi32.lib

      - name: Run certinfo test
        shell: cmd
        run: |
          certinfo.exe https://hurl.dev

  ubuntu:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y build-essential libcurl4-openssl-dev

      - name: Build certinfo
        run: gcc certinfo.c -o certinfo -lcurl

      - name: Run certinfo test
        run: ./certinfo https://hurl.dev

  macos:
    runs-on: macos-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Install dependencies
        run: brew install curl || true

      - name: Build certinfo
        run: clang certinfo.c -o certinfo -lcurl

      - name: Run certinfo test
        run: ./certinfo https://hurl.dev
